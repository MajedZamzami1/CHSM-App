<html>
    <head>
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"
        integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ=="
        crossorigin=""/>

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script src="database.json"></script>
        <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"
        integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ=="
        crossorigin=""></script>
    </head>
        <body style="background-color:rgb(245, 243, 243);"></bodystyle> 
            <style>
                thead{
                    color:rgb(245, 243, 243)
                }
                table{
                    color: azure;
                }
                th{ 
                color:rgb(255, 255, 255);
                    }
                #map { height: 720px; width: 980px ; border: 2px solid black; top: 50; margin-right: auto; margin-left: auto;}
            </style>

            <table class="table table-light">
                <tr  class="bg-info">
                    <th data-column="id">ID </th>
                    <th data-column="name">Name </th>
                    <th data-column="surname">Surname </th>
                    <th data-column="birthdate">BirthDate </th>
                    <th data-column="date">Trip Date </th>
                    <th data-column="picked">Picked up  </th>
                    <th data-column="waiver">Waiver </th>
                    <th data-column="location">Location </th>
                    <th data-column="endRide">End Ride </th>
                </tr>

                <thead id="tableHead"></thead>
                <tbody id="myTable"></tbody>
            </table>

            <div id="map"></div>
            <script>
                const formEl = document.querySelector("form");
                const tbodyEl = document.querySelector("tbody");
                const tableEl = document.querySelector("table");
                var tripsLst = {};
                var Users = []

                var formData = JSON.stringify($("#Users").serializeArray());

                function fetching(){
                    fetch("database.json")
                    .then(response => {
                    return response.json();
                    })
                    .then(jsondata => console.log(jsondata))
                }

                const myList = document.querySelector('ul');
                const myRequest = new Request('database.json');
                fetch(myRequest)
                .then(response => response.json())
                .then(data => {
                    for (const Rider of data.riders) {
                        if (Rider.date != ''){
                            Users.push({"id":Rider.id, "name":Rider.name, "surname":Rider.surname, "birthdate": Rider.birthdate, "date":Rider.date, "picked":Rider.picked,  "waiver":Rider.waiver, "location":Rider.location})
                        }
                    }
                    JSON.stringify(Users)
                    buildTable(Users)
                })
                .catch(console.error);

                function buildTable(data){
                    var table = document.getElementById('myTable')
                    table.innerHTML = ''
                    for (var i = 0; i < data.length; i++){
                        var row = 
                        `<tr>
                                <td>${data[i].id}</td>
                                <td>${data[i].name}</td>
                                <td>${data[i].surname}</td>
                                <td>${data[i].birthdate}</td>
                                <td>${data[i].date}</td>
                                <td><button type="button">${data[i].picked}</button> </td> 
                                <td>${data[i].waiver}</td>
                                <td>${data[i].location} </td>
                                <td><button class="deleteBtn">End Ride</button></td>
                            </tr>`
                        table.innerHTML += row;
                        
                        if (data[i].date != ''){
                        var rider = {"ID": data[i].id, "Name": data[i].name, "Surname": data[i].surname, "Birthday": data[i].birthdate, "Date": data[i].date, 'Picked':data[i].picked ,"Waiver": data[i].waiver , "Location": data[i].location};
                        tripsLst[data[i].date + data[i].id] = rider;
                        }
                    }

                    //console.log(tripsLst)
                    showlocations();
                    }
                    
                function onDeleteRow(e) {
                    $(".deleteBtn").click(function() {
                    var $row = $(this).closest("tr");    // Find the row
                    var $tds = $row.find("td");
                    var i = 0
                    $.each($tds, function() {
                        if (i == 0){
                            editTable($(this).text())
                        }
                        i += 1
                    });
                    
                });
                    
                }
                function editTable(id){
                url = 'http://127.0.0.1:8000/cgi-bin/getData.py?' + 'function=' + 'get' + '&id=' + id
                fetch(url)
                    .then(data => {
                    return data.json();
                    }).then(json => { 
                    console.log(json['status']);
                });

                console.log("hi")
            }
                tableEl.addEventListener("click", onDeleteRow);

                var popup = L.popup();
                var greenIcon = new L.Icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowSize: [41, 41]
                });
            
                var map = L.map('map').setView([30.351815, -97.700188], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: 'Â© OpenStreetMap'
                }).addTo(map);
                

                var goergianAcres = L.polygon([[30.339410441869536, -97.70027080476106],
                    [30.35833211360448, -97.68806220171041],
                    [30.363198989985634, -97.69709275248165],
                    [30.348226383043677, -97.71320677205651]
                ]).addTo(map);
                
                function lstRiders(trvlNum,rider){
                    if (rider != null && trvlNum != 0 && trvlNum != null)
                        tripsLst[trvlNum] = rider;
                }

                function showlocations(){
                    var keys= Object.keys(tripsLst);
                    for(var i = 0; i < keys.length; i++){

                    var lat = parseFloat(tripsLst[keys[i]]["Location"][0]);
                    var lng = parseFloat(tripsLst[keys[i]]["Location"][1]);
                    var marker =  L.marker([lat,lng]);
                    marker.addTo(map).on('click', function(e) {

                        var latDes = marker.getLatLng().lat;
                        var longDes = marker.getLatLng().lng;
                        
                        navigator.geolocation.getCurrentPosition(function(location) {    
                            var latlng = new L.LatLng(location.coords.latitude, location.coords.longitude);
                            var curLat = latlng.lat;
                            var curLng = latlng.lng;
                            var url = "https://www.google.com/maps/dir/?api=1&";
                            var origin = "origin=" +  curLat + "," + curLng;
                            var destination = "&destination=" + latDes + "," + longDes;
                            var newUrl = new URL(url + origin + destination);
                            
                        var win = window.open(newUrl, '_blank');
                        win.focus();
                    
                                    });
                                });

                        marker.bindPopup(tripsLst[keys[i]]["Name"]+" "+tripsLst[keys[i]]["Surname"]+" ID:"+tripsLst[keys[i]]["ID"]);
                        marker.on('mouseover', function (e) {
                        this.openPopup();
                                });
                        marker.on('mouseout', function (e) {
                            this.closePopup();
                                });  
                            }; 
                    }
                    
                    
                function checkArea(marker, poly){
                    
                    var inside = false;
                        var x = marker.getLatLng().lat, y = marker.getLatLng().lng;
                    for (var ii=0;ii<poly.getLatLngs().length;ii++){
                    var polyPoints = poly.getLatLngs()[ii];
                    for (var i = 0, j = polyPoints.length - 1; i < polyPoints.length; j = i++) {
                        var xi = polyPoints[i].lat, yi = polyPoints[i].lng;
                        var xj = polyPoints[j].lat, yj = polyPoints[j].lng;

                        var intersect = ((yi > y) != (yj > y))
                        && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
                    if (intersect) inside = !inside;
                            } 
                        }
                    if (!inside) writeMessage(marker)
                        return inside
                    }
                function writeMessage(mark)  {
                    popup.setLatLng(mark.getLatLng()).setContent("Outside the scope of pickup ").openOn(map);
                    }

                function sendMarker(marker){
                    if (makrer != null && countMarkers == true)
                        return marker;
                    }

                function endRide(tripNum){
                    tripsLst[tripNum]["Location"].remove();
                    delete tripsLst[tripNum];
                }
                function onLocationFound(e) {
                    var radius = e.accuracy;

                L.marker(e.latlng, {icon: greenIcon}).addTo(map).bindPopup("You are within " + radius + " meters from this point").openPopup();
                L.circle(e.latlng, radius).addTo(map);
                    }



                    function onLocationError(e) {
                        alert('Location not found, try to  turn on "finding location".');
                            }               
        
                map.on('locationerror', onLocationError);
                map.on('locationfound', onLocationFound);
                map.locate({setView: true, watch: false, maxZoom: 13});
            </script>
        </body>

</html>